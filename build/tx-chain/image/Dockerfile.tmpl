FROM --platform=$BUILDPLATFORM {{ .From }} as builder

ARG TARGETARCH
COPY {{if .InDocker}}docker.{{end}}linux.$TARGETARCH/{{ .TXdBinary }} /{{ .TXdBinary }}
COPY docker.linux.$TARGETARCH/{{ .CosmovisorBinary }} /{{ .CosmovisorBinary }}

{{ $txd := .TXdBinary }}
{{ range .Networks }}
RUN mkdir -p /app/{{ . }}/cosmovisor/genesis/bin && \
  ln -s /{{ $txd }} /app/{{ . }}/cosmovisor/genesis/bin/txd
{{ end }}

RUN chmod -R 777 /app

FROM --platform=$TARGETPLATFORM {{ .From }}

COPY --from=builder /app /app
COPY --from=builder /{{ .TXdBinary }} /{{ .TXdBinary }}
COPY --from=builder /{{ .CosmovisorBinary }} /{{ .CosmovisorBinary }}

ENTRYPOINT ["/bin/cosmovisor", "run"]
